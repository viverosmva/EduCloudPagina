<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EduCloud - Registro</title>
  <style>
    body{font-family:'Segoe UI',Tahoma,Verdana,sans-serif;background:linear-gradient(135deg,#1e3a8a,#3b82f6);
      min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;margin:0}
    .card{background:#fff;border-radius:16px;box-shadow:0 12px 32px rgba(0,0,0,.15);max-width:520px;width:100%;padding:28px}
    h1{color:#1e3a8a;margin:0 0 8px}
    .muted{color:#64748b;margin:0 0 18px}
    .row{display:grid;gap:12px}
    input{width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:10px;outline:none}
    input:focus{border-color:#93c5fd;box-shadow:0 0 0 3px rgba(59,130,246,.2)}
    .btn{width:100%;padding:12px;border:none;border-radius:12px;background:linear-gradient(135deg,#3b82f6,#1e3a8a);color:#fff;font-weight:800;cursor:pointer;margin-top:10px}
    .link{color:#ef4444;text-decoration:none;font-weight:700}
    .msg{display:none;margin-top:10px;padding:10px;border-radius:10px;font-size:13px}
    .msg.err{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
    .msg.ok{background:#ecfeff;color:#155e75;border:1px solid #a5f3fc}
  </style>
</head>
<body>
  <div class="card">
    <h1>Crear cuenta</h1>
    <p class="muted">Regístrate para usar EduCloud.</p>

    <div id="alert" class="msg err"></div>
    <div id="ok" class="msg ok"></div>

    <form id="form" novalidate>
      <div class="row">
        <input id="nombre"   placeholder="Nombre" required>
        <input id="apellido" placeholder="Apellido" required>
        <input id="email"    type="email" placeholder="Correo electrónico" autocomplete="email" required>
        <input id="telefono" placeholder="Teléfono (opcional)">
        <input id="password" type="password" placeholder="Contraseña (mín. 6)" minlength="6" autocomplete="new-password" required>
      </div>
      <button class="btn" type="submit">Registrarme</button>
    </form>

    <p class="muted" style="margin-top:10px">¿Ya tienes cuenta? <a class="link" href="inicio_sesion.html">Inicia sesión</a></p>
  </div>

  <script>
    // === Claves y utils (MISMAS que login) ===
    const USERS_KEY='educloud_users';
    const SESSION_KEY='educloud_session';
    const $ = s=>document.querySelector(s);
    const emailNorm = s => (s||'').trim().toLowerCase();
    function loadUsers(){ try { return JSON.parse(localStorage.getItem(USERS_KEY)||'[]'); } catch { return []; } }
    function saveUsers(list){ localStorage.setItem(USERS_KEY, JSON.stringify(list)); }
    function setSession(s){ localStorage.setItem(SESSION_KEY, JSON.stringify(s)); }
    function show(el,text=''){ el.textContent=text; el.style.display=text?'block':'none'; }

    document.getElementById('form').addEventListener('submit',(e)=>{
      e.preventDefault();
      e.stopPropagation(); // evita propagación del evento
      
      const nombre   = $('#nombre').value.trim();
      const apellido = $('#apellido').value.trim();
      const email    = emailNorm($('#email').value);
      const telefono = $('#telefono').value.trim();
      const password = $('#password').value;

      const err=$('#alert'), ok=$('#ok'); show(err,''); show(ok,'');

      if(!nombre || !apellido || !email || password.length<6){
        show(err,'Completa todos los campos (la contraseña debe tener al menos 6 caracteres).'); return;
      }
      if(email==='maria.garcia@uni.edu'){
        show(err,'Ese correo está reservado para el docente. Usa otro correo.'); return;
      }

      const users = loadUsers();
      if(users.some(u => (u.email||'').toLowerCase()===email)){
        show(err,'Ese correo ya está registrado.'); return;
      }

      const user = {
        email,
        password, // (demo)
        nombre: `${nombre} ${apellido}`.trim(),
        telefono,
        rol:'estudiante',
        createdAt:new Date().toISOString()
      };
      users.push(user); 
      saveUsers(users);

      // Crea sesión y al panel de estudiantes
      const sessionData = { 
        email: user.email, 
        nombre: user.nombre, 
        rol: user.rol, 
        loginAt: new Date().toISOString() 
      };
      
      // Asegurar que la sesión se guarde correctamente
      localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
      
      // Verificar que se guardó correctamente
      const verificar = localStorage.getItem(SESSION_KEY);
      if(!verificar){
        show(err,'Error al crear la sesión. Por favor, intenta de nuevo.');
        return;
      }
      
      show(ok,'Cuenta creada. Redirigiendo…');
      
      // Pequeño delay para mostrar el mensaje y asegurar que todo está guardado
      setTimeout(() => {
        window.location.href = 'indice.html';
      }, 800);
    });
  </script>
</body>
</html>
